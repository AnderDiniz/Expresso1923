<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>IboVasco</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 40px;
      background: #111;
      color: #fff;
    }
    #filters {
      margin-bottom: 30px;
    }
    canvas {
      background: #222;
      padding: 20px;
      border-radius: 10px;
    }

    select[multiple] {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #fefefe;
      color: #000;
      font-size: 14px;
      width: 300px;
      height: 150px;
    }

    select[multiple] option {
      padding: 5px;
      color: #000;
      background-color: #fff;
    }

    .choices__inner,
    .choices__list--multiple .choices__item {
      color: #000 !important;
      background-color: #fff !important;
    }

    .choices__item--selectable.is-highlighted {
      background-color: #ddd !important;
      color: #000 !important;
    }

    .choices__list--dropdown .choices__item--choice {
      color: #000 !important;
      background-color: #fff !important;
    }

    .choices__list--dropdown .choices__item--choice.is-highlighted {
      background-color: #ddd !important;
      color: #000 !important;
    }

    .container {
      max-width: 1300px;
      margin: 0 auto;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>IboVasco ðŸ“ˆ</h1>

    <div id="filters">
      <select id="playerFilter" multiple></select>
      <select id="gameFilter" multiple></select>
    </div>

    <canvas id="iboVascoChart" width="1000" height="500"></canvas>

    <script>
      const playerFilter = new Choices('#playerFilter', {
        removeItemButton: true,
        placeholder: true,
        placeholderValue: 'Selecione jogadores'
      });

      const gameFilter = new Choices('#gameFilter', {
        removeItemButton: true,
        placeholder: true,
        placeholderValue: 'Selecione jogos'
      });

      const jogadores = ['Vegetti', 'Payet', 'Lucas Piton', 'ZÃ© Gabriel', 'Leo Jardim'];
      const jogos = ['CariocÃ£o', 'Santos (C)', 'Melgar (F)', 'Corinthians (F)', 'Puerto Cabello (C)', 'Sport (C)', 'CearÃ¡ (F)', 'Flamengo (N)'];

      jogadores.forEach(j => playerFilter.setChoices([{ value: j, label: j }], 'value', 'label', false));
      jogos.forEach(j => gameFilter.setChoices([{ value: j, label: j }], 'value', 'label', false));

      const notasIniciais = {
        'Vegetti': 8,
        'Payet': 7,
        'Lucas Piton': 6,
        'ZÃ© Gabriel': 5,
        'Leo Jardim': 9
      };

      const ajustes = {
        'Vegetti': [1, 2, 5, 2, 5, 1, 1],
        'Payet': [2, 1, -1, 1, -1, 2, -2],
        'Lucas Piton': [-1, 1, 1, 2, -2, 1, 1],
        'ZÃ© Gabriel': [2, -2, 1, -1, 1, -2, 2],
        'Leo Jardim': [1, 1, -1, 2, -2, 2, -1]
      };

      const dados = {};
      jogadores.forEach(jogador => {
        let notas = [notasIniciais[jogador]];
        ajustes[jogador].forEach(ajuste => {
          const novaNota = notas[notas.length - 1] + ajuste;
          notas.push(Math.max(0, Math.min(20, novaNota)));
        });
        dados[jogador] = notas;
      });

      const cores = {
        'Vegetti': '#FF6384',
        'Payet': '#36A2EB',
        'Lucas Piton': '#FFCE56',
        'ZÃ© Gabriel': '#4BC0C0',
        'Leo Jardim': '#9966FF'
      };

  

      const multipleTooltipsPlugin = {
  id: 'customTooltips',
  afterDraw(chart) {
    const { ctx } = chart;
    const tooltipsPorNota = {};

    chart.data.datasets.forEach((dataset, datasetIndex) => {
      const meta = chart.getDatasetMeta(datasetIndex);
      const lastIndex = dataset.data.length - 1;
      const point = meta.data[lastIndex];
      if (!point) return;

      const notaFinal = dataset.data[lastIndex];
      if (!tooltipsPorNota[notaFinal]) tooltipsPorNota[notaFinal] = [];
      tooltipsPorNota[notaFinal].push({ point, label: `${dataset.label}: Nota ${notaFinal}` });
    });

    Object.values(tooltipsPorNota).forEach(group => {
  group.forEach((item, i) => {
    // Ajusta o offset para espalhar verticalmente
    const offsetY = (i - (group.length - 1) / 2) * 22;
    
    // Desloca os tooltips para a direita do grÃ¡fico
    const offsetX = chart.width - 80;  // PosiÃ§Ã£o Ã  direita (ajuste o valor 100 conforme necessÃ¡rio)
    const y = item.point.y + offsetY;  // MantÃ©m a posiÃ§Ã£o Y original do grÃ¡fico

    ctx.save();
    ctx.font = 'bold 12px sans-serif';
    ctx.textAlign = 'center';  // Centraliza horizontalmente
    ctx.textBaseline = 'middle';  // Centraliza verticalmente
    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';  // Cor do fundo preto

    // Medindo a largura do texto e criando o fundo preto
    const textWidth = ctx.measureText(item.label).width;
    const padding = 6;  // EspaÃ§o ao redor do texto
    const boxWidth = textWidth + padding * 2;  // Largura do fundo
    const boxHeight = 20;  // Altura do fundo preto

    // Desenha o fundo preto Ã  direita (ajuste o valor de deslocamento)
    ctx.fillRect(offsetX - boxWidth / 2, y - boxHeight / 2, boxWidth, boxHeight);

    // Desenha o texto branco dentro do fundo preto
    ctx.fillStyle = '#fff';
    ctx.fillText(item.label, offsetX, y);  // Centraliza o texto dentro do fundo preto

    ctx.restore();
  });
});


  }
};






      const highlightSameScoresPlugin = {
        id: 'highlightSameScores',
        afterDatasetsDraw(chart) {
          const ctx = chart.ctx;
          const datasets = chart.data.datasets;
          const lastIndex = chart.data.labels.length - 1;

          const scores = datasets.map(dataset => dataset.data[lastIndex]);

          const groups = {};
          scores.forEach((score, i) => {
            if (!groups[score]) groups[score] = [];
            groups[score].push(i);
          });

          Object.values(groups).forEach(group => {
            if (group.length > 1) {
              for (let i = 0; i < group.length - 1; i++) {
                const player1 = chart.getDatasetMeta(group[i]).data[lastIndex];
                const player2 = chart.getDatasetMeta(group[i + 1]).data[lastIndex];

                ctx.beginPath();
                ctx.moveTo(player1.x, player1.y);
                ctx.lineTo(player2.x, player2.y);
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
              }
            }
          });
        }
      };

    

      const ctx = document.getElementById('iboVascoChart').getContext('2d');
let chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: jogos,
    datasets: []
  },
  options: {
    responsive: true,
    interaction: {
      mode: 'nearest',
      intersect: false
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: { color: '#fff' }
      },
      x: {
        ticks: { color: '#fff' }
      }
    },
    plugins: {
      legend: {
        labels: {
          color: '#fff',
          font: {
            size: 14,
            weight: 'bold'
          }
        }
      },
      tooltip: {
        callbacks: {
          label: function (context) {
            return `${context.dataset.label}: Nota ${context.formattedValue}`;
          }
        }
      },
      datalabels: {
        display: false // Desativa os rÃ³tulos
      }
    },
    layout: {
      padding: {
        right: 150,  // Ajuste o valor para aumentar o espaÃ§o Ã  direita
        top: 10,     // Ajuste o valor para ajustar a parte superior do grÃ¡fico, se necessÃ¡rio
        bottom: 10    // Ajuste o valor para ajustar a parte inferior, se necessÃ¡rio
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: {
          color: '#fff'
        }
      },
      x: {
        ticks: {
          color: '#fff'
        }
      }
    }
  },
  plugins: [ChartDataLabels, multipleTooltipsPlugin, highlightSameScoresPlugin]
});







      function atualizarGrafico() {
        const jogadoresSelecionados = playerFilter.getValue(true);
        chart.data.datasets = jogadoresSelecionados.map(jogador => ({
          label: jogador,
          data: dados[jogador],
          borderColor: cores[jogador],
          backgroundColor: cores[jogador],
          tension: 0.3,
          fill: false
        }));
        chart.update();
      }




      document.getElementById('playerFilter').addEventListener('change', atualizarGrafico);
    </script>
  </div>
</body>
</html>
